<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>너의 기분은 어떠니?2 (How are you feeling?)</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: system-ui, -apple-system, "Noto Sans KR", Arial, sans-serif;
  }

  body {
    display: grid;
    place-items: center;
    background: #eef2f8;
    transition: background .3s ease;
    overflow: hidden;
    position: relative;
  }

  /* positive 배경 */
  body.pos {
    background: linear-gradient(135deg,#bfe4ff,#76b7ff);
  }

  /* negative 배경 */
  body.neg {
    background: linear-gradient(135deg,#aab0ba,#5e6672);
  }

  .card {
    width: min(640px,92vw);
    background: #ffffffcc;
    backdrop-filter: blur(6px);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,.12);
    position: relative;
    z-index: 2; /* 비와 해보다 위/아래 조정: 비(1), 카드(2), 해(3)로 갈 거라 해는 더 위로 줄 예정 */
  }

  h1 {
    margin: 0 0 10px;
    font-size: clamp(22px,4.5vw,32px);
    line-height: 1.3;
  }

  .row {
    display: flex;
    gap: 10px;
  }

  input {
    flex: 1;
    padding: 12px 14px;
    font-size: 16px;
    border-radius: 12px;
    border: 1px solid #d6dde7;
    outline: none;
  }

  input:focus {
    border-color: #86a7ff;
    box-shadow: 0 0 0 4px #86a7ff33;
  }

  button {
    padding: 0 16px;
    border: 0;
    border-radius: 12px;
    background: #111827;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
  }

  button:active {
    transform: scale(.98);
  }

  .status {
    margin-top: 10px;
    opacity: .9;
    min-height: 1.5em;
    font-size: 15px;
    line-height: 1.4;
  }

  .extra-message {
    margin-top: 6px;
    font-size: 14px;
    line-height: 1.4;
    color: #374151;
    min-height: 1.4em;
  }

  /* 비 (neg일 때만 보임) */
  .rain {
    position: fixed;
    inset: 0;
    pointer-events: none;
    display: none;
    z-index: 1;
  }

  body.neg .rain {
    display: block;
  }

  .drop {
    position: absolute;
    top: -120px;
    width: 2px;
    height: 90px;
    background: linear-gradient(to bottom, #ffffff88, #ffffff00);
    animation: fall linear infinite;
    opacity: .7;
  }

  @keyframes fall {
    to { transform: translateY(120vh); }
  }

  /* 해 (positive일 때 왼쪽 상단에 등장) */
  .sun {
    position: fixed;
    top: -80px;   /* 시작은 화면 바깥 위쪽 */
    left: -80px;  /* 시작은 화면 바깥 왼쪽 */
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #fffbe8 0%, #ffec6a 40%, #ffcf33 70%, #ffba00 100%);
    box-shadow:
      0 0 30px 10px rgba(255,236,106,0.6),
      0 0 60px 30px rgba(255,207,51,0.25),
      0 0 120px 60px rgba(255,186,0,0.15);
    pointer-events: none;
    opacity: 0;
    transform: translate(-40px,-40px) scale(0.8);
    transition:
      opacity .6s ease,
      transform .6s cubic-bezier(.16,1,.3,1);
    z-index: 3;
  }

  /* 살짝 흔들리는 빛 퍼짐 애니메이션 */
  @keyframes sunPulse {
    0% {
      box-shadow:
        0 0 30px 10px rgba(255,236,106,0.6),
        0 0 60px 30px rgba(255,207,51,0.25),
        0 0 120px 60px rgba(255,186,0,0.15);
    }
    50% {
      box-shadow:
        0 0 36px 14px rgba(255,236,106,0.7),
        0 0 70px 36px rgba(255,207,51,0.3),
        0 0 130px 70px rgba(255,186,0,0.2);
    }
    100% {
      box-shadow:
        0 0 30px 10px rgba(255,236,106,0.6),
        0 0 60px 30px rgba(255,207,51,0.25),
        0 0 120px 60px rgba(255,186,0,0.15);
    }
  }

  /* body.pos일 때 sun이 부드럽게 안쪽으로 내려와서 나타남 */
  body.pos .sun {
    opacity: 1;
    transform: translate(20px,20px) scale(1);
    animation: sunPulse 2.5s ease-in-out infinite;
  }
</style>
</head>
<body>
  <div class="card" role="region" aria-label="기분 입력 카드">
    <h1>너의 기분은 어떠니? (How are you feeling today?)</h1>
    <p style="margin:0 0 12px">
      기분 단어를 적고 Enter 또는 버튼을 눌러 보세요.<br />
      Write one feeling word and press Enter. <br />
      예: happy / sad / 행복 / 우울 / 짜증 / 설렘
    </p>
    <div class="row">
      <input
        id="mood"
        type="text"
        placeholder="예: happy / sad / 행복 / 우울 ..."
        autocomplete="off"
        aria-label="지금 기분"
      />
      <button id="goBtn" type="button" aria-label="확인">확인</button>
    </div>
    <div class="status" id="status" aria-live="polite"></div>
    <div class="extra-message" id="extraMessage" aria-live="polite"></div>
  </div>

  <!-- 비 -->
  <div class="rain" id="rain"></div>

  <!-- 해 -->
  <div class="sun" id="sun" aria-hidden="true"></div>

<script>
  // ===== DOM refs =====
  const body = document.body;
  const input = document.getElementById('mood');
  const goBtn = document.getElementById('goBtn');
  const statusEl = document.getElementById('status');
  const extraEl = document.getElementById('extraMessage');
  const rainEl = document.getElementById('rain');
  const sunEl = document.getElementById('sun');

  // ===== Web Audio context & utils =====
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx || audioCtx.state === 'closed') {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
  }

  // fade out placeholder (미래에 여러 소스 추적하고 stop 하고 싶으면 여기서 하면 됨)
  function fadeOutAll() {
    // 현재 구조에서는 각 사운드가 자기 gain envelope으로 알아서 끝나므로
    // 따로 전역 stop은 안 해도 돼.
  }

  function playPositive() {
    ensureAudio();
    const now = audioCtx.currentTime;
    const master = audioCtx.createGain();
    master.gain.value = 0;
    master.connect(audioCtx.destination);

    // 짧은 상행 3음 (도-미-솔)
    [261.63, 329.63, 392.00].forEach((f, i) => {
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = f;

      const t0 = now + i * 0.03;
      const t1 = t0 + 0.35;

      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(0.6, t0 + 0.05);
      g.gain.exponentialRampToValueAtTime(0.0001, t1);

      osc.connect(g);
      g.connect(master);

      osc.start(t0);
      osc.stop(t1 + 0.02);
    });

    master.gain.linearRampToValueAtTime(0.9, now + 0.05);
    master.gain.exponentialRampToValueAtTime(0.0001, now + 0.6);
  }

  function playNegative() {
    ensureAudio();
    const now = audioCtx.currentTime;
    const dur = 1.8;

    // 화이트 노이즈 (비 소리 느낌)
    const bufferSize = Math.floor(audioCtx.sampleRate * dur);
    const buf = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
      data[i] = (Math.random() * 2 - 1) * 0.45;
    }

    const src = audioCtx.createBufferSource();
    src.buffer = buf;

    const lp = audioCtx.createBiquadFilter();
    lp.type = 'lowpass';
    lp.frequency.value = 1800;

    const hp = audioCtx.createBiquadFilter();
    hp.type = 'highpass';
    hp.frequency.value = 180;

    const m = audioCtx.createGain();
    m.gain.value = 0;

    src.connect(lp);
    lp.connect(hp);
    hp.connect(m);
    m.connect(audioCtx.destination);

    m.gain.linearRampToValueAtTime(0.7, now + 0.1);
    m.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    src.start(now);
    src.stop(now + dur + 0.02);
  }

  // ===== 감정 단어 사전 =====
  const POS = new Set([
    // EN
    'happy','joy','joyful','glad','good','great','awesome','amazing','love','lovely',
    'excited','exciting','delight','delighted','proud','calm','peace','peaceful',
    'relaxed','fun','fine','cool','superb','fantastic','wonderful','hopeful','optimistic',
    // KR
    '행복','기쁨','기쁘','좋아','좋음','좋다','최고','사랑','설렘','설레','신남','신나',
    '뿌듯','평온','여유','편안','힐링','괜찮','감사','만족','행복해','즐거','즐거움'
  ]);

  const NEG = new Set([
    // EN
    'sad','bad','worse','terrible','awful','angry','mad','upset','depress','depressed',
    'tired','sleepy','bored','boring','stress','stressed','anxious','anxiety','lonely',
    'hate','sick','hurt','pain','gloomy','blue','down',
    // KR
    '슬픔','슬퍼','슬프','우울','피곤','지침','지쳐','짜증','화남','화나','스트레스',
    '불안','불안해','외롭','외로움','싫어','싫다','최악','답답','속상','심란','침울',
    '걱정','걱정돼','걱정이'
  ]);

  const POS_HINT = [
    '행복','기쁨','설렘','좋','사랑','신나','뿌듯','편안','평온','즐거','멋',
    '환희','희망','hope','joy','love','good','great','awesome','calm','peace',
    'relax','delight','proud','fun'
  ];

  const NEG_HINT = [
    '슬프','우울','피곤','지루','짜증','화나','불안','외롭','싫','최악','답답',
    '속상','걱정','아픔','아파','괴로','pain','sad','depress','tired','bored',
    'stress','anxious','lonely','hate','hurt','sick','gloom','down','blue'
  ];

  function guessSentiment(text) {
    const v = String(text || '').trim().toLowerCase();
    if (!v) return 'neutral';

    // 완전 일치
    if (POS.has(v)) return 'pos';
    if (NEG.has(v)) return 'neg';

    const raw = String(text).trim();

    // 부분 포함 키워드
    if (POS_HINT.some(k => v.includes(k) || raw.includes(k))) return 'pos';
    if (NEG_HINT.some(k => v.includes(k) || raw.includes(k))) return 'neg';

    // 간단 부정 문양
    if (/\b(not|no|never|없음|아니|별로|그닥)\b/i.test(raw)) return 'neg';

    return 'neutral';
  }

  // ===== 비 효과 =====
  function makeRain(n=40) {
    rainEl.innerHTML = '';
    const W = innerWidth;
    for (let i = 0; i < n; i++) {
      const d = document.createElement('div');
      d.className = 'drop';
      d.style.left = (Math.random() * W) + 'px';
      d.style.animationDuration = (0.7 + Math.random() * 1.2) + 's';
      d.style.animationDelay = (Math.random() * 1.0) + 's';
      rainEl.appendChild(d);
    }
  }

  function setStatus(msg) {
    statusEl.textContent = msg;
  }
  function setExtra(msg) {
    extraEl.textContent = msg;
  }

  function applyMood(text) {
    const s = guessSentiment(text);

    if (s === 'pos') {
      body.classList.remove('neg');
      body.classList.add('pos');

      setStatus('✨ 좋은 기분이네요! You seem to feel good 💙');
      setExtra('이 기분 간직하고 싶으면 캡처해 둬도 좋아 😌');

      rainEl.innerHTML = '';
      fadeOutAll();
      playPositive();

      // 해는 body.pos에 의해 자동으로 나타남 (CSS 전환)
    } else if (s === 'neg') {
      body.classList.remove('pos');
      body.classList.add('neg');

      setStatus('☔ 안 괜찮을 때도 있어요. It’s okay to feel low.');
      setExtra('지금 이 감정을 말해준 것만으로도 이미 잘하고 있어요.');

      makeRain(48);
      fadeOutAll();
      playNegative();

    } else {
      body.classList.remove('pos','neg');

      setStatus('중립이에요. 한 단어 더 자세히 적어볼까요? (예: 행복, 우울, excited, stressed)');
      setExtra('');

      rainEl.innerHTML = '';
      fadeOutAll();
    }
  }

  // ===== 이벤트 =====
  goBtn.addEventListener('click', () => applyMood(input.value));
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') applyMood(input.value);
  });

  // ===== 초기 안내 =====
  setStatus('기분을 한 단어로 적어보세요. 예: happy / sad / 행복 / 우울 …');
  setExtra('');
</script>
</body>
</html>
